var AcademicMarkdown;
(function (AcademicMarkdown) {
    var Editor;
    (function (Editor) {
        //Creat event listeners of the buttons
        document.getElementById("bold-btn").addEventListener("click", () => {
            emphasis("**");
        });
        document.getElementById("italic-btn").addEventListener("click", () => {
            emphasis("*");
        });
        document.getElementById("underline-btn").addEventListener("click", () => {
            emphasis("__");
        });
        document.getElementById("strikethrough-btn").addEventListener("click", () => {
            emphasis("~~");
        });
        document.getElementById("code-inline-btn").addEventListener("click", () => {
            emphasis("`");
        });
        document.getElementById("link-btn").addEventListener("click", () => {
            hyperlink("url", "title");
        });
        document.getElementById("image-btn").addEventListener("click", () => {
            insert("![image title](url)");
        });
        document.getElementById("youtube-btn").addEventListener("click", () => {
            insert("~[video title](url)");
        });
        document.getElementById("icon-btn").addEventListener("click", () => {
            insert("[fa-facebook-official]");
        });
        // undo
        document.getElementById("undo-btn").addEventListener("click", () => {
            Editor.editor.trigger("undo-btn", "undo", null);
        });
        //redo
        document.getElementById("redo-btn").addEventListener("click", () => {
            Editor.editor.trigger("redo-btn", "redo", null);
        });
        document.getElementById("amd-theme-0").addEventListener("click", () => {
            AcademicMarkdown.Utility.changeStyle(0);
        });
        document.getElementById("amd-theme-1").addEventListener("click", () => {
            AcademicMarkdown.Utility.changeStyle(1);
        });
        document.getElementById("amd-theme-2").addEventListener("click", () => {
            AcademicMarkdown.Utility.changeStyle(2);
        });
        document.getElementById("table-fit").addEventListener("click", () => {
            fitTableButton();
        });
        document.getElementById("pdf-btn").addEventListener("click", () => {
            savePdfButton();
            // let doc = new (<any>window).jsPDF();
            // let specialElementHandlers = {
            //     '#editor': function (element, renderer) {
            //         return true;
            //     }
            // };
            // doc.fromHTML($('#markdown-output-container').html(), 15, 15, {
            //     'width': 170,
            //     'elementHandlers': specialElementHandlers
            // });
            // doc.save('A.MD.pdf');
        });
        function fitTableButton() {
            let range = Editor.editor.getSelection();
            let textSelected = Editor.editor.getModel().getValueInRange(range);
            insert(fitTable(textSelected), range);
        }
        function emphasis(identifier) {
            // this function adds/removes surrounding characters(identifiers) to the selected text
            let range = Editor.editor.getSelection();
            let startPosition = new monaco.Position(range.startLineNumber, range.startColumn);
            let endPosition = new monaco.Position(range.endLineNumber, range.endColumn);
            let textSelected = Editor.editor.getModel().getValueInRange(range);
            if (!textSelected) {
                textSelected = "insert your text here";
            }
            let textLength = textSelected.length;
            let offset = identifier.length;
            //detect if the selected range is already processed
            if (textAtPosition(startPosition, -offset) == identifier
                && textAtPosition(endPosition, offset) == identifier) {
                let newRange = modifyRange(range, -offset, offset);
                insert(textSelected, newRange);
                startPosition = Editor.editor.getModel().modifyPosition(startPosition, -offset);
            }
            else {
                insert(identifier + textSelected + identifier, range);
                startPosition = Editor.editor.getModel().modifyPosition(startPosition, offset);
            }
            //reset cursor position after the operation
            endPosition = Editor.editor.getModel().modifyPosition(startPosition, textLength);
            let selection = new monaco.Selection(startPosition.lineNumber, startPosition.column, endPosition.lineNumber, endPosition.column);
            Editor.editor.setSelection(selection);
        }
        function textAtPosition(position, offset) {
            let offsetPosition = Editor.editor.getModel().modifyPosition(position, offset);
            let range = positionToRange(position, offsetPosition);
            return Editor.editor.getModel().getValueInRange(range);
        }
        function positionToRange(startPosition, endPosition) {
            return new monaco.Selection(startPosition.lineNumber, startPosition.column, endPosition.lineNumber, endPosition.column);
        }
        function modifyRange(range, startOffset, endOffset) {
            let startPosition = new monaco.Position(range.startLineNumber, range.startColumn);
            let endPosition = new monaco.Position(range.endLineNumber, range.endColumn);
            startPosition = Editor.editor.getModel().modifyPosition(startPosition, startOffset);
            endPosition = Editor.editor.getModel().modifyPosition(endPosition, endOffset);
            return positionToRange(startPosition, endPosition);
        }
        function insert(text, range = Editor.editor.getSelection()) {
            let id = { major: 1, minor: 1 };
            let edit = { identifier: id, range: range, text: text, forceMoveMarkers: true };
            Editor.editor.executeEdits("insert", [edit]);
            Editor.editor.focus();
        }
        Editor.insert = insert;
        function table(row, column) {
            let table = "";
            for (let i = 1; i <= row; i++) {
                for (let j = 1; j <= column; j++) {
                    let columnID = String.fromCharCode(64 + j); // need to fix 
                    let rowID = i;
                    table = table + columnID + rowID + "\t";
                }
                table = table + "\n";
            }
            insert(table);
        }
        function hyperlink(url, title) {
            let text = `[link text](${url})`;
            insert(text);
        }
        function image(url, title) {
            let text = `[image text](${url} ${(title) ? (`"${title}"`) : (``)})`;
            insert(text);
        }
        function validateTable(table) {
            let isTable = true;
            let rows = table.match(/[^\r\n]+/g);
            if (!rows || rows.length < 2) {
                isTable = false;
            }
            else {
                let rowNumber = rows.length;
                for (let rowID = 0; rowID < rowNumber; rowID++) {
                    let row = rows[rowID];
                    if (!row.match(/^\|([^\|]+\|)+/)) {
                        isTable = false;
                    }
                }
            }
            return isTable;
        }
        function fitTable(table) {
            if (!validateTable(table))
                return table;
            let rows = table.match(/[^\r\n]+/g);
            let rowNumber = rows.length;
            let columnNumber = rows[0].split("|").length - 2;
            let columnMaxWidth = new Array(columnNumber).fill(0);
            let cells = [];
            for (let rowID = 0; rowID < rowNumber; rowID++) {
                let row = rows[rowID];
                let columns = row.split("|").slice(1, 1 + columnNumber);
                cells[rowID] = [];
                for (let columnID = 0; columnID < columnNumber; columnID++) {
                    let cell = columns[columnID].trim();
                    cells[rowID][columnID] = cell;
                    if (cell.length > columnMaxWidth[columnID]) {
                        columnMaxWidth[columnID] = cell.length;
                    }
                }
            }
            let fittedTable = "";
            for (let rowID = 0; rowID < rowNumber; rowID++) {
                let fittedRow = "";
                for (let columnID = 0; columnID < columnNumber; columnID++) {
                    let lineFilling = (rowID == 1) ? "-" : " ";
                    let cell = cells[rowID][columnID];
                    let spaceNumber = columnMaxWidth[columnID] - cell.length;
                    fittedRow = fittedRow + "| " + cell + lineFilling.repeat(spaceNumber) + " ";
                }
                fittedTable = fittedTable + fittedRow + "|\n";
            }
            return (fittedTable);
        }
        Editor.fitTable = fitTable;
        function savePdfButton() {
            pdfRocket($('#markdown-output-container').html(), savePdf);
        }
        function savePdf(pdfFile) {
            saveAs(pdfFile, "AcademicMarkdown.pdf");
        }
        function pdfRocket(html, savePdf) {
            var self = this;
            self.save = savePdf;
            self.req = new XMLHttpRequest();
            var url = "http://api.html2pdfrocket.com/pdf";
            var apiKey = "484e1e7d-d90f-439d-96ba-0a93de2e5e51";
            var zoom = 2;
            var margin = 10;
            var UsePrintStylesheet = true;
            var FileName = "AMD";
            // Additional parameters can be added here
            var data = "apikey=" + apiKey +
                "&value=" + encodeURIComponent(html) +
                "&zoom=" + zoom +
                "&marginLeft=" + margin +
                "&marginRight=" + margin +
                "&marginTop=" + margin +
                "&marginBottom=" + margin +
                "&usePrintStylesheet=" + UsePrintStylesheet +
                "&fileName=" + FileName;
            self.req.onload = function (event) {
                self.save(self.req.response);
            };
            self.req.open("POST", url, true);
            self.req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            self.req.responseType = "blob";
            self.req.send(data);
        }
    })(Editor = AcademicMarkdown.Editor || (AcademicMarkdown.Editor = {}));
})(AcademicMarkdown || (AcademicMarkdown = {}));

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LElBQUksQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLG1DQUFtQyxDQUFDLENBQUM7WUFDL0UsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDO1lBRS9CLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hCLENBQUM7SUFDTCxDQUFDLEVBbFIwQixNQUFNLEdBQU4sdUJBQU0sS0FBTix1QkFBTSxRQWtSaEM7QUFBRCxDQUFDLEVBbFJTLGdCQUFnQixLQUFoQixnQkFBZ0IsUUFrUnpCIiwiZmlsZSI6ImVkaXRvci10b29sYmFyLmpzIiwic291cmNlc0NvbnRlbnQiOlsibmFtZXNwYWNlIEFjYWRlbWljTWFya2Rvd24uRWRpdG9yIHtcclxuXHJcbiAgICAvL0NyZWF0IGV2ZW50IGxpc3RlbmVycyBvZiB0aGUgYnV0dG9uc1xyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJib2xkLWJ0blwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGVtcGhhc2lzKFwiKipcIik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIml0YWxpYy1idG5cIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBlbXBoYXNpcyhcIipcIik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInVuZGVybGluZS1idG5cIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBlbXBoYXNpcyhcIl9fXCIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzdHJpa2V0aHJvdWdoLWJ0blwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGVtcGhhc2lzKFwifn5cIik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNvZGUtaW5saW5lLWJ0blwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGVtcGhhc2lzKFwiYFwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibGluay1idG5cIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBoeXBlcmxpbmsoXCJ1cmxcIiwgXCJ0aXRsZVwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaW1hZ2UtYnRuXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XHJcbiAgICAgICAgaW5zZXJ0KFwiIVtpbWFnZSB0aXRsZV0odXJsKVwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwieW91dHViZS1idG5cIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBpbnNlcnQoXCJ+W3ZpZGVvIHRpdGxlXSh1cmwpXCIpO1xyXG4gICAgfSk7XHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImljb24tYnRuXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XHJcbiAgICAgICAgaW5zZXJ0KFwiW2ZhLWZhY2Vib29rLW9mZmljaWFsXVwiKTtcclxuICAgIH0pO1xyXG4gICAgLy8gdW5kb1xyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ1bmRvLWJ0blwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGVkaXRvci50cmlnZ2VyKFwidW5kby1idG5cIiwgXCJ1bmRvXCIsIG51bGwpXHJcbiAgICB9KTtcclxuXHJcbiAgICAvL3JlZG9cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmVkby1idG5cIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBlZGl0b3IudHJpZ2dlcihcInJlZG8tYnRuXCIsIFwicmVkb1wiLCBudWxsKVxyXG4gICAgfSlcclxuXHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFtZC10aGVtZS0wXCIpLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XHJcbiAgICAgICAgVXRpbGl0eS5jaGFuZ2VTdHlsZSgwKTtcclxuICAgIH0pXHJcblxyXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbWQtdGhlbWUtMVwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIFV0aWxpdHkuY2hhbmdlU3R5bGUoMSk7XHJcbiAgICB9KVxyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYW1kLXRoZW1lLTJcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcclxuICAgICAgICBVdGlsaXR5LmNoYW5nZVN0eWxlKDIpO1xyXG4gICAgfSlcclxuXHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRhYmxlLWZpdFwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIGZpdFRhYmxlQnV0dG9uKCk7XHJcbiAgICB9KVxyXG5cclxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicGRmLWJ0blwiKS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgIHNhdmVQZGZCdXR0b24oKTtcclxuICAgICAgICAvLyBsZXQgZG9jID0gbmV3ICg8YW55PndpbmRvdykuanNQREYoKTtcclxuICAgICAgICAvLyBsZXQgc3BlY2lhbEVsZW1lbnRIYW5kbGVycyA9IHtcclxuICAgICAgICAvLyAgICAgJyNlZGl0b3InOiBmdW5jdGlvbiAoZWxlbWVudCwgcmVuZGVyZXIpIHtcclxuICAgICAgICAvLyAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gfTtcclxuXHJcbiAgICAgICAgLy8gZG9jLmZyb21IVE1MKCQoJyNtYXJrZG93bi1vdXRwdXQtY29udGFpbmVyJykuaHRtbCgpLCAxNSwgMTUsIHtcclxuICAgICAgICAvLyAgICAgJ3dpZHRoJzogMTcwLFxyXG4gICAgICAgIC8vICAgICAnZWxlbWVudEhhbmRsZXJzJzogc3BlY2lhbEVsZW1lbnRIYW5kbGVyc1xyXG4gICAgICAgIC8vIH0pO1xyXG4gICAgICAgIC8vIGRvYy5zYXZlKCdBLk1ELnBkZicpO1xyXG4gICAgfSlcclxuXHJcblxyXG4gICAgZnVuY3Rpb24gZml0VGFibGVCdXR0b24oKSB7XHJcbiAgICAgICAgbGV0IHJhbmdlID0gZWRpdG9yLmdldFNlbGVjdGlvbigpO1xyXG4gICAgICAgIGxldCB0ZXh0U2VsZWN0ZWQgPSBlZGl0b3IuZ2V0TW9kZWwoKS5nZXRWYWx1ZUluUmFuZ2UocmFuZ2UpO1xyXG4gICAgICAgIGluc2VydChmaXRUYWJsZSh0ZXh0U2VsZWN0ZWQpLCByYW5nZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZW1waGFzaXMoaWRlbnRpZmllcjogc3RyaW5nKSB7XHJcbiAgICAgICAgLy8gdGhpcyBmdW5jdGlvbiBhZGRzL3JlbW92ZXMgc3Vycm91bmRpbmcgY2hhcmFjdGVycyhpZGVudGlmaWVycykgdG8gdGhlIHNlbGVjdGVkIHRleHRcclxuICAgICAgICBsZXQgcmFuZ2UgPSBlZGl0b3IuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgICAgbGV0IHN0YXJ0UG9zaXRpb24gPSBuZXcgbW9uYWNvLlBvc2l0aW9uKHJhbmdlLnN0YXJ0TGluZU51bWJlciwgcmFuZ2Uuc3RhcnRDb2x1bW4pO1xyXG4gICAgICAgIGxldCBlbmRQb3NpdGlvbiA9IG5ldyBtb25hY28uUG9zaXRpb24ocmFuZ2UuZW5kTGluZU51bWJlciwgcmFuZ2UuZW5kQ29sdW1uKTtcclxuICAgICAgICBsZXQgdGV4dFNlbGVjdGVkID0gZWRpdG9yLmdldE1vZGVsKCkuZ2V0VmFsdWVJblJhbmdlKHJhbmdlKTtcclxuICAgICAgICBpZiAoIXRleHRTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICB0ZXh0U2VsZWN0ZWQgPSBcImluc2VydCB5b3VyIHRleHQgaGVyZVwiXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB0ZXh0TGVuZ3RoID0gdGV4dFNlbGVjdGVkLmxlbmd0aDtcclxuICAgICAgICBsZXQgb2Zmc2V0ID0gaWRlbnRpZmllci5sZW5ndGg7XHJcblxyXG4gICAgICAgIC8vZGV0ZWN0IGlmIHRoZSBzZWxlY3RlZCByYW5nZSBpcyBhbHJlYWR5IHByb2Nlc3NlZFxyXG4gICAgICAgIGlmICh0ZXh0QXRQb3NpdGlvbihzdGFydFBvc2l0aW9uLCAtb2Zmc2V0KSA9PSBpZGVudGlmaWVyXHJcbiAgICAgICAgICAgICYmIHRleHRBdFBvc2l0aW9uKGVuZFBvc2l0aW9uLCBvZmZzZXQpID09IGlkZW50aWZpZXIpIHtcclxuICAgICAgICAgICAgbGV0IG5ld1JhbmdlID0gbW9kaWZ5UmFuZ2UocmFuZ2UsIC1vZmZzZXQsIG9mZnNldCk7XHJcbiAgICAgICAgICAgIGluc2VydCh0ZXh0U2VsZWN0ZWQsIG5ld1JhbmdlKTtcclxuICAgICAgICAgICAgc3RhcnRQb3NpdGlvbiA9IGVkaXRvci5nZXRNb2RlbCgpLm1vZGlmeVBvc2l0aW9uKHN0YXJ0UG9zaXRpb24sIC1vZmZzZXQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGluc2VydChpZGVudGlmaWVyICsgdGV4dFNlbGVjdGVkICsgaWRlbnRpZmllciwgcmFuZ2UpO1xyXG4gICAgICAgICAgICBzdGFydFBvc2l0aW9uID0gZWRpdG9yLmdldE1vZGVsKCkubW9kaWZ5UG9zaXRpb24oc3RhcnRQb3NpdGlvbiwgb2Zmc2V0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vcmVzZXQgY3Vyc29yIHBvc2l0aW9uIGFmdGVyIHRoZSBvcGVyYXRpb25cclxuICAgICAgICBlbmRQb3NpdGlvbiA9IGVkaXRvci5nZXRNb2RlbCgpLm1vZGlmeVBvc2l0aW9uKHN0YXJ0UG9zaXRpb24sIHRleHRMZW5ndGgpO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb24gPSBuZXcgbW9uYWNvLlNlbGVjdGlvbihcclxuICAgICAgICAgICAgc3RhcnRQb3NpdGlvbi5saW5lTnVtYmVyLFxyXG4gICAgICAgICAgICBzdGFydFBvc2l0aW9uLmNvbHVtbixcclxuICAgICAgICAgICAgZW5kUG9zaXRpb24ubGluZU51bWJlcixcclxuICAgICAgICAgICAgZW5kUG9zaXRpb24uY29sdW1uXHJcbiAgICAgICAgKTtcclxuICAgICAgICBlZGl0b3Iuc2V0U2VsZWN0aW9uKHNlbGVjdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdGV4dEF0UG9zaXRpb24ocG9zaXRpb246IG1vbmFjby5JUG9zaXRpb24sIG9mZnNldDogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IG9mZnNldFBvc2l0aW9uID0gZWRpdG9yLmdldE1vZGVsKCkubW9kaWZ5UG9zaXRpb24ocG9zaXRpb24sIG9mZnNldCk7XHJcbiAgICAgICAgbGV0IHJhbmdlID0gcG9zaXRpb25Ub1JhbmdlKHBvc2l0aW9uLCBvZmZzZXRQb3NpdGlvbik7XHJcbiAgICAgICAgcmV0dXJuIGVkaXRvci5nZXRNb2RlbCgpLmdldFZhbHVlSW5SYW5nZShyYW5nZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcG9zaXRpb25Ub1JhbmdlKFxyXG4gICAgICAgIHN0YXJ0UG9zaXRpb246IG1vbmFjby5JUG9zaXRpb24sXHJcbiAgICAgICAgZW5kUG9zaXRpb246IG1vbmFjby5JUG9zaXRpb24pIHtcclxuICAgICAgICByZXR1cm4gbmV3IG1vbmFjby5TZWxlY3Rpb24oXHJcbiAgICAgICAgICAgIHN0YXJ0UG9zaXRpb24ubGluZU51bWJlcixcclxuICAgICAgICAgICAgc3RhcnRQb3NpdGlvbi5jb2x1bW4sXHJcbiAgICAgICAgICAgIGVuZFBvc2l0aW9uLmxpbmVOdW1iZXIsXHJcbiAgICAgICAgICAgIGVuZFBvc2l0aW9uLmNvbHVtblxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW9kaWZ5UmFuZ2UocmFuZ2U6IG1vbmFjby5JUmFuZ2UsIHN0YXJ0T2Zmc2V0OiBudW1iZXIsIGVuZE9mZnNldDogbnVtYmVyKTogbW9uYWNvLlNlbGVjdGlvbiB7XHJcbiAgICAgICAgbGV0IHN0YXJ0UG9zaXRpb24gPSBuZXcgbW9uYWNvLlBvc2l0aW9uKHJhbmdlLnN0YXJ0TGluZU51bWJlciwgcmFuZ2Uuc3RhcnRDb2x1bW4pO1xyXG4gICAgICAgIGxldCBlbmRQb3NpdGlvbiA9IG5ldyBtb25hY28uUG9zaXRpb24ocmFuZ2UuZW5kTGluZU51bWJlciwgcmFuZ2UuZW5kQ29sdW1uKTtcclxuICAgICAgICBzdGFydFBvc2l0aW9uID0gZWRpdG9yLmdldE1vZGVsKCkubW9kaWZ5UG9zaXRpb24oc3RhcnRQb3NpdGlvbiwgc3RhcnRPZmZzZXQpO1xyXG4gICAgICAgIGVuZFBvc2l0aW9uID0gZWRpdG9yLmdldE1vZGVsKCkubW9kaWZ5UG9zaXRpb24oZW5kUG9zaXRpb24sIGVuZE9mZnNldCk7XHJcbiAgICAgICAgcmV0dXJuIHBvc2l0aW9uVG9SYW5nZShzdGFydFBvc2l0aW9uLCBlbmRQb3NpdGlvbik7XHJcbiAgICB9XHJcbiAgICBleHBvcnQgZnVuY3Rpb24gaW5zZXJ0KFxyXG4gICAgICAgIHRleHQ6IHN0cmluZyxcclxuICAgICAgICByYW5nZTogbW9uYWNvLlNlbGVjdGlvbiA9IGVkaXRvci5nZXRTZWxlY3Rpb24oKSkge1xyXG4gICAgICAgIGxldCBpZCA9IHsgbWFqb3I6IDEsIG1pbm9yOiAxIH07XHJcbiAgICAgICAgbGV0IGVkaXQgPSB7IGlkZW50aWZpZXI6IGlkLCByYW5nZTogcmFuZ2UsIHRleHQ6IHRleHQsIGZvcmNlTW92ZU1hcmtlcnM6IHRydWUgfTtcclxuICAgICAgICBlZGl0b3IuZXhlY3V0ZUVkaXRzKFwiaW5zZXJ0XCIsIFtlZGl0XSk7XHJcbiAgICAgICAgZWRpdG9yLmZvY3VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdGFibGUocm93LCBjb2x1bW4pIHtcclxuICAgICAgICBsZXQgdGFibGUgPSBcIlwiO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHJvdzsgaSsrKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAxOyBqIDw9IGNvbHVtbjsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29sdW1uSUQgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDY0ICsgaik7IC8vIG5lZWQgdG8gZml4IFxyXG4gICAgICAgICAgICAgICAgbGV0IHJvd0lEID0gaTtcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gdGFibGUgKyBjb2x1bW5JRCArIHJvd0lEICsgXCJcXHRcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0YWJsZSA9IHRhYmxlICsgXCJcXG5cIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaW5zZXJ0KHRhYmxlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoeXBlcmxpbmsodXJsOiBzdHJpbmcsIHRpdGxlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IHRleHQgPSBgW2xpbmsgdGV4dF0oJHt1cmx9KWA7XHJcbiAgICAgICAgaW5zZXJ0KHRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGltYWdlKHVybDogc3RyaW5nLCB0aXRsZT86IHN0cmluZykge1xyXG4gICAgICAgIGxldCB0ZXh0ID0gYFtpbWFnZSB0ZXh0XSgke3VybH0gJHsodGl0bGUpID8gKGBcIiR7dGl0bGV9XCJgKSA6IChgYCl9KWA7XHJcbiAgICAgICAgaW5zZXJ0KHRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFibGUodGFibGU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGxldCBpc1RhYmxlID0gdHJ1ZTtcclxuICAgICAgICBsZXQgcm93cyA9IHRhYmxlLm1hdGNoKC9bXlxcclxcbl0rL2cpO1xyXG4gICAgICAgIGlmICghcm93cyB8fCByb3dzLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgaXNUYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHJvd051bWJlciA9IHJvd3MubGVuZ3RoO1xyXG4gICAgICAgICAgICBmb3IgKGxldCByb3dJRCA9IDA7IHJvd0lEIDwgcm93TnVtYmVyOyByb3dJRCsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcm93ID0gcm93c1tyb3dJRF07XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJvdy5tYXRjaCgvXlxcfChbXlxcfF0rXFx8KSsvKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzVGFibGUgPSBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaXNUYWJsZVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBmdW5jdGlvbiBmaXRUYWJsZSh0YWJsZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCF2YWxpZGF0ZVRhYmxlKHRhYmxlKSkgcmV0dXJuIHRhYmxlO1xyXG5cclxuICAgICAgICBsZXQgcm93cyA9IHRhYmxlLm1hdGNoKC9bXlxcclxcbl0rL2cpO1xyXG4gICAgICAgIGxldCByb3dOdW1iZXIgPSByb3dzLmxlbmd0aDtcclxuICAgICAgICBsZXQgY29sdW1uTnVtYmVyID0gcm93c1swXS5zcGxpdChcInxcIikubGVuZ3RoIC0gMjtcclxuICAgICAgICBsZXQgY29sdW1uTWF4V2lkdGg6IG51bWJlcltdID0gbmV3IEFycmF5KGNvbHVtbk51bWJlcikuZmlsbCgwKTtcclxuICAgICAgICBsZXQgY2VsbHM6IHN0cmluZ1tdW10gPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgcm93SUQgPSAwOyByb3dJRCA8IHJvd051bWJlcjsgcm93SUQrKykge1xyXG4gICAgICAgICAgICBsZXQgcm93ID0gcm93c1tyb3dJRF07XHJcbiAgICAgICAgICAgIGxldCBjb2x1bW5zID0gcm93LnNwbGl0KFwifFwiKS5zbGljZSgxLCAxICsgY29sdW1uTnVtYmVyKTtcclxuICAgICAgICAgICAgY2VsbHNbcm93SURdID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGNvbHVtbklEID0gMDsgY29sdW1uSUQgPCBjb2x1bW5OdW1iZXI7IGNvbHVtbklEKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCBjZWxsID0gY29sdW1uc1tjb2x1bW5JRF0udHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgY2VsbHNbcm93SURdW2NvbHVtbklEXSA9IGNlbGw7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbC5sZW5ndGggPiBjb2x1bW5NYXhXaWR0aFtjb2x1bW5JRF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2x1bW5NYXhXaWR0aFtjb2x1bW5JRF0gPSBjZWxsLmxlbmd0aFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgZml0dGVkVGFibGUgPSBcIlwiXHJcbiAgICAgICAgZm9yIChsZXQgcm93SUQgPSAwOyByb3dJRCA8IHJvd051bWJlcjsgcm93SUQrKykge1xyXG4gICAgICAgICAgICBsZXQgZml0dGVkUm93ID0gXCJcIlxyXG4gICAgICAgICAgICBmb3IgKGxldCBjb2x1bW5JRCA9IDA7IGNvbHVtbklEIDwgY29sdW1uTnVtYmVyOyBjb2x1bW5JRCsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGluZUZpbGxpbmcgPSAocm93SUQgPT0gMSkgPyBcIi1cIiA6IFwiIFwiXHJcbiAgICAgICAgICAgICAgICBsZXQgY2VsbCA9IGNlbGxzW3Jvd0lEXVtjb2x1bW5JRF07XHJcbiAgICAgICAgICAgICAgICBsZXQgc3BhY2VOdW1iZXIgPSBjb2x1bW5NYXhXaWR0aFtjb2x1bW5JRF0gLSBjZWxsLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGZpdHRlZFJvdyA9IGZpdHRlZFJvdyArIFwifCBcIiArIGNlbGwgKyBsaW5lRmlsbGluZy5yZXBlYXQoc3BhY2VOdW1iZXIpICsgXCIgXCJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmaXR0ZWRUYWJsZSA9IGZpdHRlZFRhYmxlICsgZml0dGVkUm93ICsgXCJ8XFxuXCJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAoZml0dGVkVGFibGUpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlUGRmQnV0dG9uKCkge1xyXG4gICAgICAgIHBkZlJvY2tldCgkKCcjbWFya2Rvd24tb3V0cHV0LWNvbnRhaW5lcicpLmh0bWwoKSwgc2F2ZVBkZilcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlUGRmKHBkZkZpbGUpIHtcclxuICAgICAgICBzYXZlQXMocGRmRmlsZSwgXCJBY2FkZW1pY01hcmtkb3duLnBkZlwiKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwZGZSb2NrZXQoaHRtbCwgc2F2ZVBkZikge1xyXG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgc2VsZi5zYXZlID0gc2F2ZVBkZjtcclxuICAgICAgICBzZWxmLnJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG5cclxuICAgICAgICB2YXIgdXJsID0gXCJodHRwOi8vYXBpLmh0bWwycGRmcm9ja2V0LmNvbS9wZGZcIjtcclxuICAgICAgICB2YXIgYXBpS2V5ID0gXCI0ODRlMWU3ZC1kOTBmLTQzOWQtOTZiYS0wYTkzZGUyZTVlNTFcIjtcclxuICAgICAgICB2YXIgem9vbSA9IDI7XHJcbiAgICAgICAgdmFyIG1hcmdpbiA9IDEwO1xyXG4gICAgICAgIHZhciBVc2VQcmludFN0eWxlc2hlZXQgPSB0cnVlXHJcbiAgICAgICAgdmFyIEZpbGVOYW1lID0gXCJBTURcIlxyXG4gICAgICAgIC8vIEFkZGl0aW9uYWwgcGFyYW1ldGVycyBjYW4gYmUgYWRkZWQgaGVyZVxyXG4gICAgICAgIHZhciBkYXRhID0gXCJhcGlrZXk9XCIgKyBhcGlLZXkgK1xyXG4gICAgICAgICAgICBcIiZ2YWx1ZT1cIiArIGVuY29kZVVSSUNvbXBvbmVudChodG1sKSArXHJcbiAgICAgICAgICAgIFwiJnpvb209XCIgKyB6b29tICtcclxuICAgICAgICAgICAgXCImbWFyZ2luTGVmdD1cIiArIG1hcmdpbiArXHJcbiAgICAgICAgICAgIFwiJm1hcmdpblJpZ2h0PVwiICsgbWFyZ2luICtcclxuICAgICAgICAgICAgXCImbWFyZ2luVG9wPVwiICsgbWFyZ2luICtcclxuICAgICAgICAgICAgXCImbWFyZ2luQm90dG9tPVwiICsgbWFyZ2luICtcclxuICAgICAgICAgICAgXCImdXNlUHJpbnRTdHlsZXNoZWV0PVwiICsgVXNlUHJpbnRTdHlsZXNoZWV0ICtcclxuICAgICAgICAgICAgXCImZmlsZU5hbWU9XCIgKyBGaWxlTmFtZTtcclxuXHJcbiAgICAgICAgc2VsZi5yZXEub25sb2FkID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIHNlbGYuc2F2ZShzZWxmLnJlcS5yZXNwb25zZSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgc2VsZi5yZXEub3BlbihcIlBPU1RcIiwgdXJsLCB0cnVlKTtcclxuICAgICAgICBzZWxmLnJlcS5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7XHJcbiAgICAgICAgc2VsZi5yZXEucmVzcG9uc2VUeXBlID0gXCJibG9iXCI7XHJcblxyXG4gICAgICAgIHNlbGYucmVxLnNlbmQoZGF0YSk7XHJcbiAgICB9XHJcbn0iXSwic291cmNlUm9vdCI6IiJ9
